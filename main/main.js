if (Meteor.isClient) {




  Template.main.onRendered(function () {

var svg = d3.select("section")
    .append("svg")
    .attr("width",700)
    .attr("height",1100)

svg.append("rect")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("fill", "#84C5F6")
    .attr("fill-opacity",1);

svg.append("path")
    .attr("d","m 441.82836,1428.5805 c -2.20709,2.289 -5.01919,5.6366 -7.43919,9.8711 0,0 -8.67917,6.6308 -8.67917,9.4548 l 2.84431,7.214 2.39969,6.905 3.63,1.209 2.42,0.406 1.612,20.971 -4.035,-1.205 -4.839,0 -8.067,-0.805 -1.211,-1.214 -10.085,1.207 -8.0029,3.3216 -9.03526,1.0834 -12.10584,3.117 10.893,7.869 4.084,3.932 -5.144,20.877 c 0,0 17.246,23.902 18.61,30.41 1.359,6.5 9.681,16.488 9.681,16.488 l 9.983,2.27 10.439,-5.598 4.54,1.209 0.15,8.168 -2.873,7.414 3.479,-0.508 1.968,8.676 -8.019,3.178 -1.664,-6.203 0.452,-7.713 -1.058,-2.725 -7.263,0.906 -3.328,0.908 1.162,3.787 c 0,0 -10.791,1.211 -12.103,-4.842 l 3.529,-6.053 c 0,0 -13.465,-20.271 -13.163,-22.541 0.306,-2.273 -15.731,-26.17 -15.731,-26.17 0,0 -15.583,-20.127 -19.968,-21.789 -4.388,-1.662 -13.012,-2.117 -15.281,-6.352 -2.27,-4.234 -11.043,-17.396 -11.499,-19.816 -0.452,-2.426 -0.3,-13.012 0.91,-15.584 1.21,-2.57 5.144,-7.564 5.144,-7.564 0,0 2.723,-1.361 3.023,-1.967 0.303,-0.604 -3.932,-7.713 -3.932,-7.713 l -2.4223,-17.4338 c 7.99929,-50.8663 2.35255,-52.1116 -9.7174,-158.3963 l 105.1015,-13.4422 1.99369,2.8291 2.46751,0.6652 c 0,0 0.604,0 2.42,-0.604 1.815,-0.605 5.444,-0.605 9.077,-1.209 3.628,-0.605 9.075,2.416 9.075,2.416 0,0 -2.42,2.422 0.607,2.422 3.025,0 10.892,-2.422 10.892,-2.422 0,0 2.419,-0.604 1.209,2.422 -1.209,3.027 -1.816,5.449 -1.816,5.449 l 3.026,3.023 6.43321,4.8917 1.54775,0.5329 c 0,0 12.72248,2.5873 15.14048,5.0113 2.422,2.424 3.10256,3.2821 3.10256,3.2821 0,0 2.419,2.422 3.226,3.629 0.808,1.211 6.86,1.211 6.456,0 -0.405,-1.207 -1.21,-5.244 -1.21,-5.244 l -1.211,-4.838 c -10e-4,-0.01 4.838,-10.094 18.961,-19.367 l 0.401,6.855 1.615,2.826 c 0,0 -0.808,0.807 0.805,1.615 1.613,0.805 2.82,0.801 8.071,0.402 5.243,-0.402 10.083,-2.424 10.083,-2.424 l 3.228,-1.209 c 0,0 1.211,0.807 0.806,2.824 -0.403,2.018 -0.806,5.246 1.211,6.053 2.018,0.809 5.246,2.826 5.246,2.826 l 1.60222,3.0615 -2.00822,9.8445 12.711,12.102 3.021,2.422 4.843,-1.211 1.211,5.447 -4.84,4.234 -4.843,2.42 3.629,3.633 4.843,0 0.604,13.914 c 0,0 -5.142,1.517 -7.26,2.422 -2.119,0.914 -4.538,-0.604 -4.538,-0.604 0,0 -2.42,-0.301 -3.631,-0.301 -1.21,0 -3.932,2.118 -4.944,2.723 -1.005,0.607 -2.014,-2.123 -2.014,-2.123 l -2.724,-2.721 c 0,0 -4.237,1.211 -4.941,1.615 -0.709,0.405 1.311,8.067 1.612,9.885 0.304,1.815 0.911,4.536 0.809,5.85 -0.102,1.312 -3.228,2.32 -4.135,2.623 -0.909,0.303 -11.801,9.68 -11.801,9.68 l -3.025,2.424 -1.615,2.014 c 0,0 -0.405,0.604 -0.203,3.229 0.203,2.627 1.01,11.094 -1.21,12.707 -2.218,1.619 -4.436,3.836 -4.436,4.443 0,0.6 -2.219,4.84 -2.219,4.84 l -22.593,15.529 -3.022,17.549 -2.019,0 c -0.607,0 -4.235,-2.822 -4.235,-2.822 0,0 -11.9,8.063 -12.911,8.264 -1.009,0.205 -5.244,0.605 -6.048,0.406 -0.808,-0.201 -2.42,-4.236 -2.42,-4.236 0,0 1.613,-3.83 1.613,-4.84 0,-1.008 1.008,-3.832 1.008,-4.84 0,-1.008 -0.201,-1.613 -0.201,-1.613 l -4.70849,-3.152 c 0,0 -1.34451,0.3236 -4.16951,-0.082 -2.822,-0.406 -7.26,0.41 -9.278,-0.4 -2.016,-0.807 -4.841,0.4 -4.841,0.4 l -4.14457,2.3364 -0.63518,1.4312 -1.27801,2.501 2.42229,0.037 1.86857,0.52 0.28018,2.6019 -0.69663,1.5532 -1.29075,0.06 0.8371,-1.7427 -0.52809,-1.6575 -1.43469,-0.3556 -2.14245,0.2312 -1.8486,4.8393 -1.79989,2.2761 2.47599,0.6532 2.61918,-1.7288 2.80667,-1.0657 1.94631,1.3116 c 0,0 -1.79178,1.2186 -2.6336,1.9558 -0.84182,0.7372 -2.69135,1.0597 -3.65421,1.7413 0,0 -0.5085,0.2404 -1.26099,0.403 -0.7525,0.1627 -1.74899,0.2475 -2.72499,-0.064 z")
   
   .classed("map", true)
   .attr("transform", "matrix(5.9544964,0.80058477,-0.80058477,5.9544964,-1071.3546,-7963.8446)");

var path = svg.append("path")
   .attr("d","m 172.98701,874.36108 c -25.07058,39.27724 -12.53529,44.29136 -8.35686,50.97684 4.17843,6.68549 33.42744,23.39921 37.60587,35.09882 4.17843,11.6996 20.05647,53.48386 44.29137,38.44156 24.23489,-15.04235 25.90626,-55.15528 37.60587,-71.869 11.6996,-16.71372 21.72784,-25.07058 21.72784,-40.11293 0,-15.04235 10.86391,-44.29136 25.07058,-61.00509 14.20666,-16.71372 44.29136,-55.15527 51.81253,-75.21174 7.52118,-20.05647 25.07058,-40.11293 23.39921,-51.81254 -1.67137,-11.6996 -18.38509,-85.23997 -6.68549,-105.29644 25.23434,-26.97515 20.20071,-55.40583 18.4271,-73.48098 -2.77322,-43.25161 23.35721,-56.05036 47.5921,-71.92839 24.2349,-15.87804 36.28247,-33.86337 43.74244,-64.34783 14.10745,-55.70572 -29.13978,-51.57557 -17.04079,-98.66831 15.19589,-48.27783 7.29763,-45.76689 -9.59978,-77.66144 -23.50707,-44.37056 13.16821,-45.83675 1.85675,-82.07541 C 474.89216,94.833265 444.3822,81.539779 439.36809,84.882523")
   .attr("fill","none")
   .attr("stroke","#696969")
   .attr("stroke-linecap","round")
   .attr("stroke-width","6")
   .call(transition);

var station_data =[{"cx":173,"cy":875,"name":"Albrook"},
                  {"cx":238,"cy":997, "name": "5 de Mayo" },
                  {"cx":167,"cy":931, "name": "Curundú" },
                  {"cx":278,"cy":936, "name": "Lotería" },
                  {"cx":300,"cy":902, "name": "Santo Tomás" },
                  {"cx":340,"cy":811, "name": "Iglesia del Cármen"},
                  {"cx":383,"cy":744, "name": "Vía Argentina"},
                  {"cx":403,"cy":582, "name": "El ingenio"},
                  {"cx":396,"cy":662, "name": "Fernández de Córdova"},
                  {"cx":416,"cy":517, "name": "12 de Octubre"},
                  {"cx":446,"cy":463, "name": "Pueblo Nuevo"},
                  {"cx":510,"cy":386, "name": "San Miguelito"},
                  {"cx":491,"cy":286, "name": "Pan de Azúcar"},
                  {"cx":483,"cy":200, "name": "Los Andes"},
                  {"cx":440,"cy":84 , "name": "San Isidro"}];

svg.selectAll("ellipse")
   .data(station_data)
   .enter().append("ellipse")
   .attr("cx", function (d) { return d.cx})
   .attr("cy", function (d) { return d.cy})
   .attr("rx", "10")
   .attr("ry", "10")
   .classed("station",true);

svg.selectAll("text")
   .data(station_data)
   .enter().append("text")
   .attr("x", function (d) { return d.cx + 18})
   .attr("y", function (d) { return d.cy + 5})
   .text( function (d) { return  d.name})
   .attr("font-size", "16px")
   .attr("font-family", "sans-serif")
   .attr("fill", "black");

var startPoint = pathStartPoint(path);
 
  var marker = svg.append("circle");
    
    marker.attr("r", 7)
    .attr("id", "marker")
    //.attr("xlink:href","http://oi57.tinypic.com/2encaxh.jpg")
    //.attr("width","40px")
    //.attr("height","40px")
    .attr("transform", "translate(" + startPoint + ")");




  function pathStartPoint(path) {
    var d = path.attr("d"),
    dsplitted = d.split(" ");
    console.log(dsplitted);
    return dsplitted[1];
  }
 
  function transition(path) {
    path.transition()
        .duration(7000)
        .attrTween("stroke", tweenDash)
        .each("end", function() { d3.select(this).call(transition); });
  }
 
  function tweenDash() {
    var l = path.node().getTotalLength();
    return function(t) {
      var marker = d3.select("#marker");
      var p = path.node().getPointAtLength(t * l);

      marker.attr("transform", "translate(" + p.x + "," + p.y + ")");
      return "#696969";
    }
  }

  });

}


if (Meteor.isServer) {
  Meteor.startup(function () {
    // code to run on server at startup
  });
}
